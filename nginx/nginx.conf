worker_processes 1;

events {
    worker_connections 1024;
}

# Prometheus shared memory dictionary
lua_shared_dict prometheus_metrics 20M;

# Init Prometheus system
init_by_lua_block {
    prometheus = require("prometheus").init("prometheus_metrics")

    metric_requests = prometheus:counter(
        "openresty_http_requests_total",
        "Total HTTP requests",
        {"host", "status"}
    )

    metric_latency = prometheus:histogram(
        "openresty_http_request_duration_seconds",
        "HTTP request latency",
        {"host"}
    )
}

# Log phase = executed AFTER request finishes
log_by_lua_block {
    local host = ngx.var.host or "unknown"
    local status = ngx.var.status or "000"

    -- increment request counter
    metric_requests:inc(1, {host, status})

    -- record latency
    metric_latency:observe(ngx.now() - ngx.req.start_time(), {host})
}

http {

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=1r/s;

map $http_origin $cors_origin {
     default "";
     "http://localhost:3001" $http_origin;
     "https://staging-smp.solhapp.com" $http_origin;
     "https://solhapp.com" $http_origin;
 }

server {
       listen 80;
       server_name ai.omlogic.com;

       location /.well-known/acme-challenge/ {
           root /var/www/certbot;
       }

       location / {
           return 301 https://$host$request_uri;
       }
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name ai.omlogic.com;

    ssl_certificate /etc/letsencrypt/live/ai.omlogic.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ai.omlogic.com/privkey.pem;

    # ============================
    # PROMETHEUS METRICS ENDPOINT
    # ============================
    location /metrics {
        allow all;
        content_by_lua_block {
            prometheus:collect()
        }
    }

    location / {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://go-server:3000;

        # CORS
        add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;

        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
            add_header 'Content-Length' 0 always;
            add_header 'Content-Type' text/plain always;
            return 204;
        }

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Accept text/event-stream;

        chunked_transfer_encoding on;
    }

    location /rabbitmq/api/ {
        rewrite ^ $request_uri;
        rewrite ^/rabbitmq/api/(.*) /api/$1 break;
        return 400;
        proxy_pass http://ecomm-rabbitmq:15672$uri;
        proxy_buffering off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /rabbitmq/ {
        proxy_pass http://ecomm-rabbitmq:15672/;
        proxy_buffering off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /redis-insight/ {
        proxy_pass http://redisinsight:5540;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}
}
