server:
  http_listen_port: 80
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: kafka_logs
    kafka:
      brokers:
        - kafka:9092
      topics:
        - logs-topic
      group_id: "promtail-consumer"
      version: "3.6.0"
      assignor: "roundrobin"
      use_incoming_timestamp: false

    relabel_configs:
      - source_labels: ["__meta_kafka_topic"]
        target_label: "topic"
      - source_labels: ["__meta_kafka_partition"]
        target_label: "partition"
      - source_labels: ["__meta_kafka_group_id"]
        target_label: "group"
      - target_label: "job"
        replacement: "kafka_logs"

    pipeline_stages:
      # Parse JSON - extract nested source fields
      - json:
          expressions:
            service: service
            level: level
            msg: msg
            time: time
            source_function: source.function
            source_file: source.file
            source_line: source.line
            attrs: attrs # ✅ Changed from attrs_json to attrs

      # Set timestamp
      - timestamp:
          source: time
          format: RFC3339

      # ✅ REMOVED the first output stage

      # Format log line with attrs as string
      - template:
          source: formatted_line
          template: "{{ .msg }} | attrs={{ .attrs | toJson }}"

      # ✅ Set output to the formatted line
      - output:
          source: formatted_line

      # Extract labels from JSON
      - labels:
          service:
          level:
          source_function:
          source_file:
          source_line:
